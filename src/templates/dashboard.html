<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Insider Threat Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .risk-badge {
            color: #fff;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
        }
        .risk-critical { background: #dc3545; }
        .risk-high { background: #fd7e14; }
        .risk-medium { background: #ffc107; color: #212529; }
        .risk-low { background: #28a745; }
        /* Spinner center */
        #loading-spinner {
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
<div class="container my-4 shadow rounded p-4 bg-white">
    <h2>Insider Threat Dashboard</h2>
    <nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <span class="navbar-brand mb-0 h1">Insider Threat Detection Dashboard</span>
  </div>
</nav>
    <div class="row mb-4" id="overview-metrics">
        <!-- Cards will be loaded here -->
    </div>
    <div id="loading-spinner" style="display: none;">
        <div class="spinner-border text-primary" role="status"></div>
        <span class="ms-2">Loading data...</span>
    </div>

    <div id="dashboard-table">
        <div class="table-responsive">
            <table class="table table-bordered table-hover table-striped align-middle">
                <thead>
                <tr>
                    <th>User ID</th>
                    <th>Risk Score</th>
                    <th>Risk Level</th>
                    <th>Anomaly Score</th>
                    <th>Supervised Score</th>
                    <th>Confidence</th>
                </tr>
                </thead>
                <tbody id="top-threats-body">
                <!-- Top threats will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Bootstrap JS and Popper.js for tooltips -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Enable Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Simulate loading spinner (remove this in production)
    document.getElementById('dashboard-table').style.display = 'none';
    document.getElementById('loading-spinner').style.display = 'flex';
    setTimeout(function() {
        document.getElementById('loading-spinner').style.display = 'none';
        document.getElementById('dashboard-table').style.display = 'block';
    }, 1500);

    // Fetch overview metrics
    fetch('/api/overview')
        .then(response => response.json())
        .then(data => {
            document.getElementById('overview-metrics').innerHTML = `
                <div class="col-md-3 col-6 mb-2">
                    <div class="card text-white bg-primary h-100">
                        <div class="card-body">
                            <h5 class="card-title">Total Users</h5>
                            <p class="card-text fs-3">${data.total_users}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                    <div class="card text-white bg-danger h-100">
                        <div class="card-body">
                            <h5 class="card-title">Critical</h5>
                            <p class="card-text fs-3">${data.critical_threats}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                    <div class="card text-white bg-warning h-100">
                        <div class="card-body">
                            <h5 class="card-title">High</h5>
                            <p class="card-text fs-3">${data.high_threats}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                    <div class="card text-white bg-success h-100">
                        <div class="card-body">
                            <h5 class="card-title">Low</h5>
                            <p class="card-text fs-3">${data.low_threats}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-12 mb-2">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Avg. Risk Score</h5>
                            <p class="card-text fs-3">${data.avg_risk_score.toFixed(2)}</p>
                            <h5 class="card-title">Detection Rate</h5>
                            <p class="card-text fs-3">${data.detection_rate}</p>
                        </div>
                    </div>
                </div>
            `;
        });

    // Fetch top threats
    fetch('/api/top-threats')
        .then(response => response.json())
        .then(data => {
            let rows = '';
            data.threats.forEach(user => {
                rows += `
                <tr>
                    <td>${user.user_id ?? ''}</td>
                    <td>${user.risk_score !== undefined ? user.risk_score.toFixed(2) : 'N/A'}</td>
                    <td>
                        <span class="risk-badge risk-${user.risk_level ? user.risk_level.toLowerCase() : ''}">
                            ${user.risk_level ?? 'N/A'}
                        </span>
                    </td>
                    <td>${user.anomaly_score !== undefined ? user.anomaly_score.toFixed(2) : 'N/A'}</td>
                    <td>${user.confidence !== undefined ? user.confidence.toFixed(2) : 'N/A'}</td>
                </tr>
            `;
        });
        document.getElementById('top-threats-body').innerHTML = rows;
        document.getElementById('loading-spinner').style.display = 'none';
        document.getElementById('dashboard-table').style.display = 'block';
    });
</script>
</body>
</html>